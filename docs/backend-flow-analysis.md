# R2 Gallery åç«¯æŠ€æœ¯æµç¨‹åˆ†æ

## 1. ç³»ç»Ÿå¯åŠ¨æµç¨‹

```
main.py (FastAPI Appå¯åŠ¨)
    â”‚
    â”œâ”€> åˆå§‹åŒ– CORS ä¸­é—´ä»¶
    â”‚   â””â”€> å…è®¸æ¥æº: http://localhost:5173
    â”‚
    â”œâ”€> startup_event äº‹ä»¶è§¦å‘
    â”‚   â””â”€> asyncio.create_task(start_sync_task())
    â”‚       â””â”€> sync_images()
    â”‚           â”œâ”€> è¿æ¥ SQLite æ•°æ®åº“
    â”‚           â”œâ”€> ä½¿ç”¨ S3 paginator éå† R2 bucket
    â”‚           â”œâ”€> è·³è¿‡ thumb_ å‰ç¼€çš„ç¼©ç•¥å›¾
    â”‚           â”œâ”€> ä¸ºæ¯ä¸ªå›¾ç‰‡ç”Ÿæˆç¼©ç•¥å›¾ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    â”‚           â”œâ”€> æ–°å¢å›¾ç‰‡ -> INSERT åˆ°æ•°æ®åº“
    â”‚           â”œâ”€> å·²å­˜åœ¨å›¾ç‰‡ -> UPDATE å…ƒæ•°æ®
    â”‚           â””â”€> åˆ é™¤ R2 ä¸­ä¸å­˜åœ¨çš„å›¾ç‰‡è®°å½•
    â”‚
    â””â”€> æ³¨å†Œ /api/images è·¯ç”±
```

## 2. æ ¸å¿ƒ API æµç¨‹

### 2.1 å›¾ç‰‡ä¸Šä¼ æµç¨‹ (POST /api/images/upload)

```
å®¢æˆ·ç«¯ä¸Šä¼ æ–‡ä»¶
    â”‚
    â”œâ”€> éªŒè¯ Content-Type (image/*)
    â”œâ”€> éªŒè¯æ–‡ä»¶æ‰©å±•å (.jpg/.jpeg/.png/.gif/.webp)
    â”‚
    â”œâ”€> è¯»å–æ–‡ä»¶å†…å®¹åˆ°å†…å­˜
    â”œâ”€> å†™å…¥ä¸´æ—¶æ–‡ä»¶
    â”œâ”€> è®¡ç®— MD5 å“ˆå¸Œå€¼
    â”‚
    â”œâ”€> ç”Ÿæˆæ–‡ä»¶å: {timestamp}_{md5hash}.ext
    â”‚   â””â”€> ä¾‹: 20250101120000_abc123def456.jpg
    â”‚
    â”œâ”€> ä¸Šä¼ åŸå›¾åˆ° R2
    â”‚   â””â”€> s3_client.upload_fileobj()
    â”‚
    â”œâ”€> ç”Ÿæˆç¼©ç•¥å›¾ (300x300, JPEG 85%)
    â”‚   â”œâ”€> å¤„ç† RGBA -> RGB è½¬æ¢
    â”‚   â””â”€> ä½¿ç”¨ LANCZOS é‡é‡‡æ ·
    â”‚
    â”œâ”€> ä¸Šä¼ ç¼©ç•¥å›¾åˆ° R2: thumb_{filename}
    â”‚
    â”œâ”€> è·å–æ–‡ä»¶å…ƒæ•°æ® (head_object)
    â”‚
    â”œâ”€> ä¿å­˜åˆ° SQLite æ•°æ®åº“
    â”‚   â””â”€> Image(key, size, last_modified, url, thumbnail_url)
    â”‚
    â”œâ”€> åˆ é™¤ä¸´æ—¶æ–‡ä»¶
    â”‚
    â””â”€> è¿”å› ImageObject
```

### 2.2 å›¾ç‰‡åˆ—è¡¨æµç¨‹ (GET /api/images/list)

```
è¯·æ±‚å‚æ•°: page, page_size (1-50)
    â”‚
    â”œâ”€> è®¡ç®—åç§»é‡: offset = (page - 1) * page_size
    â”‚
    â”œâ”€> æŸ¥è¯¢æ€»æ•°: COUNT(*)
    â”‚
    â”œâ”€> åˆ†é¡µæŸ¥è¯¢
    â”‚   â””â”€> ORDER BY last_modified DESC
    â”‚   â””â”€> OFFSET + LIMIT
    â”‚
    â”œâ”€> è®¡ç®— has_more: (offset + len(items)) < total
    â”‚
    â””â”€> è¿”å› ImageListResponse
        â””â”€> items, has_more, total, current_page
```

### 2.3 æ‰‹åŠ¨åŒæ­¥æµç¨‹ (POST /api/images/sync)

```
è§¦å‘æ‰‹åŠ¨åŒæ­¥
    â”‚
    â””â”€> è°ƒç”¨ sync_images()
        â””â”€> (ä¸å¯åŠ¨æµç¨‹ç›¸åŒçš„åŒæ­¥é€»è¾‘)
```

### 2.4 å›¾ç‰‡ä¸‹è½½æµç¨‹ (GET /api/images/download/{key})

```
è¯·æ±‚å‚æ•°: key
    â”‚
    â”œâ”€> s3_client.get_object(key)
    â”‚
    â”œâ”€> è¯»å–æ–‡ä»¶å†…å®¹
    â”‚
    â””â”€> è¿”å› Response(content, media_type)
```

### 2.5 å›¾ç‰‡åˆ é™¤æµç¨‹ (DELETE /api/images/{key})

```
è¯·æ±‚å‚æ•°: key
    â”‚
    â”œâ”€> åˆ é™¤ R2 åŸå›¾: s3_client.delete_object(key)
    â”‚
    â”œâ”€> åˆ é™¤ R2 ç¼©ç•¥å›¾: s3_client.delete_object(thumb_{key})
    â”‚
    â”œâ”€> ä» SQLite åˆ é™¤è®°å½•
    â”‚
    â””â”€> è¿”å›æˆåŠŸæ¶ˆæ¯
```

## 3. æ•°æ®æµå‘

```
R2 Storage (Cloudflare)          SQLite Database          Client
     â”‚                                â”‚                      â”‚
     â”‚<â”€â”€â”€ upload_image() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                â”‚                      â”‚
     â”‚â”€â”€â”€â”€ sync_images() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
     â”‚                                â”‚                      â”‚
     â”‚                                â”‚<â”€â”€â”€ list_images() â”€â”€â”€â”¤
     â”‚                                â”‚                      â”‚
     â”‚<â”€â”€â”€ download_image() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                â”‚                      â”‚
     â”‚<â”€â”€â”€ delete_image() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                â”‚                      â”‚
```

## 4. æ½œåœ¨é—®é¢˜åˆ†æ

### ğŸ”´ ä¸¥é‡é—®é¢˜

1. **å†…å­˜æº¢å‡ºé£é™©** (`api/images.py:75`)
   - `content = await file.read()` - ä¸€æ¬¡æ€§è¯»å–æ•´ä¸ªæ–‡ä»¶åˆ°å†…å­˜
   - å¤§æ–‡ä»¶ä¸Šä¼ ä¼šå¯¼è‡´å†…å­˜å‹åŠ›
   - **å»ºè®®**: ä½¿ç”¨æµå¼ä¸Šä¼ æˆ–åˆ†å—å¤„ç†

2. **ä¸´æ—¶æ–‡ä»¶æ³„æ¼** (`api/images.py:76-82`)
   - ä½¿ç”¨ `NamedTemporaryFile(delete=False)` æ‰‹åŠ¨ç®¡ç†åˆ é™¤
   - å¼‚å¸¸æ—¶å¯èƒ½å¯¼è‡´ä¸´æ—¶æ–‡ä»¶æ®‹ç•™
   - **å»ºè®®**: ä½¿ç”¨ `with` ä¸Šä¸‹æ–‡ç®¡ç†å™¨æˆ–ç¡®ä¿ finally å—æ¸…ç†

3. **é‡å¤è®¡ç®— MD5** (`api/images.py:86-89`)
   - å…ˆå°†æ–‡ä»¶å†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼Œå†é‡æ–°è¯»å–è®¡ç®— MD5
   - **å»ºè®®**: è¾¹è¯»å–è¾¹è®¡ç®— MD5ï¼Œé¿å…äºŒæ¬¡ I/O

4. **æ•°æ®åº“ä¼šè¯ç®¡ç†é—®é¢˜** (`core/sync.py:51`)
   - `db = next(get_db())` - æ‰‹åŠ¨è°ƒç”¨ç”Ÿæˆå™¨
   - å¯èƒ½å¯¼è‡´ä¼šè¯æœªæ­£ç¡®å…³é—­
   - **å»ºè®®**: ä½¿ç”¨ä¾èµ–æ³¨å…¥æˆ–ç¡®ä¿ finally å—æ¸…ç†

5. **å¯åŠ¨æ—¶åŒæ­¥é˜»å¡** (`main.py:18`)
   - `asyncio.create_task()` åˆ›å»ºåå°ä»»åŠ¡ï¼Œä½†å¦‚æœåŒæ­¥å¤±è´¥åªæ‰“å°æ—¥å¿—
   - æ•°æ®åº“å’Œ R2 å¯èƒ½ä¸ä¸€è‡´
   - **å»ºè®®**: æ·»åŠ é‡è¯•æœºåˆ¶æˆ–å¥åº·æ£€æŸ¥

### ğŸŸ¡ ä¸­ç­‰é—®é¢˜

6. **å¹¶å‘å®‰å…¨æ€§**
   - SQLite åœ¨é«˜å¹¶å‘å†™å…¥æ—¶å¯èƒ½å‡ºç° `database is locked` é”™è¯¯
   - **å»ºè®®**: è€ƒè™‘ä½¿ç”¨ PostgreSQL æˆ–æ·»åŠ è¿æ¥æ± é…ç½®

7. **ç¼©ç•¥å›¾ç”Ÿæˆå¤±è´¥å¤„ç†** (`core/sync.py:45`)
   - ç¼©ç•¥å›¾ç”Ÿæˆå¤±è´¥æ—¶è¿”å› `None`ï¼Œä½†æ•°æ®åº“ä»ä¼šä¿å­˜è®°å½•
   - **å»ºè®®**: è®°å½•å¤±è´¥åŸå› ï¼Œæä¾›é»˜è®¤å ä½å›¾

8. **R2 å®¢æˆ·ç«¯å¤ç”¨** (`api/images.py:18`)
   - åœ¨æ¨¡å—çº§åˆ«åˆå§‹åŒ– `s3_client`ï¼Œæ‰€æœ‰è¯·æ±‚å…±äº«
   - å¦‚æœè¿æ¥å¤±è´¥ï¼Œæ‰€æœ‰åç»­è¯·æ±‚éƒ½ä¼šå¤±è´¥
   - **å»ºè®®**: è€ƒè™‘è¿æ¥æ± æˆ–æ¯æ¬¡è¯·æ±‚é‡æ–°è·å–

9. **ç¼ºå°‘é€Ÿç‡é™åˆ¶**
   - ä¸Šä¼ ã€åˆ é™¤ç­‰æ“ä½œæ²¡æœ‰é™æµä¿æŠ¤
   - **å»ºè®®**: æ·»åŠ  slowapi æˆ– FastAPI-limiter

10. **é”™è¯¯å¤„ç†ä¸å®Œå–„**
    - å¾ˆå¤šåœ°æ–¹åªæ‰“å°é”™è¯¯åæŠ›å‡ºé€šç”¨ 500 é”™è¯¯
    - **å»ºè®®**: ç»†åŒ–é”™è¯¯ç±»å‹ï¼Œè¿”å›æ›´æœ‰æ„ä¹‰çš„é”™è¯¯ä¿¡æ¯

### ğŸŸ¢ ä¼˜åŒ–å»ºè®®

11. **åˆ†é¡µæ€§èƒ½ä¼˜åŒ–** (`api/images.py:35`)
    - `COUNT(*)` åœ¨å¤§æ•°æ®é‡æ—¶è¾ƒæ…¢
    - **å»ºè®®**: ç¼“å­˜æ€»æ•°æˆ–ä½¿ç”¨æ¸¸æ ‡åˆ†é¡µ

12. **ç¼©ç•¥å›¾å°ºå¯¸é…ç½®**
    - ç¡¬ç¼–ç  300x300 å°ºå¯¸
    - **å»ºè®®**: ç§»åˆ°é…ç½®æ–‡ä»¶

13. **æ—¥å¿—ç³»ç»Ÿ**
    - ä½¿ç”¨ `print()` è¾“å‡ºæ—¥å¿—
    - **å»ºè®®**: ä½¿ç”¨ logging æ¨¡å—ï¼Œæ”¯æŒæ—¥å¿—çº§åˆ«å’Œæ ¼å¼åŒ–

14. **healthcheck ç«¯ç‚¹**
    - ç¼ºå°‘å¥åº·æ£€æŸ¥æ¥å£
    - **å»ºè®®**: æ·»åŠ  `/health` ç«¯ç‚¹æ£€æŸ¥æ•°æ®åº“å’Œ R2 è¿æ¥

15. **æ–‡ä»¶ç±»å‹éªŒè¯å¢å¼º**
    - ä»…æ£€æŸ¥æ‰©å±•åå’Œ MIME type
    - **å»ºè®®**: ä½¿ç”¨ python-magic æ£€æŸ¥çœŸå®æ–‡ä»¶ç±»å‹

## 5. æ¨èæ”¹è¿›ä¼˜å…ˆçº§

### P0 (ç«‹å³ä¿®å¤)
- ä¿®å¤å†…å­˜æº¢å‡ºé£é™© (å¤§æ–‡ä»¶ä¸Šä¼ )
- ä¿®å¤æ•°æ®åº“ä¼šè¯ç®¡ç†é—®é¢˜
- ä¿®å¤ä¸´æ—¶æ–‡ä»¶æ³„æ¼

### P1 (çŸ­æœŸä¼˜åŒ–)
- æ·»åŠ é‡è¯•æœºåˆ¶åˆ°å¯åŠ¨åŒæ­¥
- ä¼˜åŒ– MD5 è®¡ç®—é€»è¾‘
- æ”¹è¿›é”™è¯¯å¤„ç†å’Œæ—¥å¿—

### P2 (é•¿æœŸä¼˜åŒ–)
- è€ƒè™‘æ•°æ®åº“è¿ç§» (SQLite -> PostgreSQL)
- æ·»åŠ é€Ÿç‡é™åˆ¶
- æ·»åŠ å¥åº·æ£€æŸ¥å’Œç›‘æ§

## 6. ä»£ç è´¨é‡æŒ‡æ ‡

- **åœˆå¤æ‚åº¦**: upload_image å‡½æ•°è¾ƒé«˜ (~15)ï¼Œå»ºè®®æ‹†åˆ†
- **ä»£ç å¤ç”¨**: storage.py çš„ get_r2_client() è¢«å¤šå¤„è°ƒç”¨ï¼Œè‰¯å¥½
- **æ¨¡å—è®¾è®¡**: åˆ†å±‚æ¸…æ™° (core/models/api)ï¼Œç¬¦åˆå•ä¸€èŒè´£åŸåˆ™
- **é”™è¯¯å¤„ç†**: ä¸å¤Ÿç»†è‡´ï¼Œéœ€è¦æ”¹è¿›
